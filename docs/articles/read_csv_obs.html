<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="harpIO">
<title>Read observations from CSV files • harpIO</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Read observations from CSV files">
<meta property="og:description" content="harpIO">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">harpIO</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/file_options.html">Options for file formats</a>
    <a class="dropdown-item" href="../articles/read_csv_obs.html">Read observations from CSV files</a>
    <a class="dropdown-item" href="../articles/read_raw_forecast.html">Reading forecast model data</a>
    <a class="dropdown-item" href="../articles/transformations.html">Transforming forecast model data</a>
    <a class="dropdown-item" href="../articles/write_forecast_data.html">Writing forecast model data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/harphub/harpIO/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Read observations from CSV files</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/harphub/harpIO/blob/HEAD/vignettes/read_csv_obs.Rmd" class="external-link"><code>vignettes/read_csv_obs.Rmd</code></a></small>
      <div class="d-none name"><code>read_csv_obs.Rmd</code></div>
    </div>

    
    
<p><em>harpIO</em> only includes functionality to read observations from
<em>vobs</em> files, though observations could come in many formats. A
simple format could be a comma separated variables (CSV) text file. harp
is written in a way that you can write your own functions that harp’s
read functions will call so that the data formats you’re working with in
harp will always be the same regardless of the file formats they came
from. This vignette demonstrates how you can make a function that
<code><a href="../reference/read_obs_file.html">read_obs_file()</a></code> or <code><a href="../reference/read_obs.html">read_obs()</a></code> could call to
read in CSV files following a particular format.</p>
<p>Let’s say our CSV data have columns for station ID (“stationId”),
station elevation (“stationElevation”), and columns for the variables 2m
temperature (“TA”), 10m wind speed (“FF10”), 1-hour precipitation
(“RR1”), 2m relative humidity, (“RH2”) and mean sea level pressure
(“MSLP”), and that there is one file for each observation time, We’ll
begin by making a function to make some fake data following these
conventions.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/harphub/harpIO" class="external-link">harpIO</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: harpCore</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'harpCore'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_fake_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">num_stn</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">num_stn</span><span class="op">)</span> <span class="co"># so stationElevation is the same every time</span></span>
<span>  <span class="va">station_elevs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">num_stn</span>, <span class="fl">0</span>, <span class="fl">350</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    stationId        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">num_stn</span><span class="op">)</span>,</span>
<span>    stationElevation <span class="op">=</span> <span class="va">station_elevs</span>,</span>
<span>    TA               <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">num_stn</span>, <span class="fl">5</span>, <span class="fl">35</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    FF10             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">num_stn</span>, <span class="fl">0.25</span>, <span class="fl">35</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    RR1              <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">num_stn</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">num_stn</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    RH2              <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">num_stn</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    MSLP             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">num_stn</span>, <span class="fl">970</span>, <span class="fl">1030</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And then another function to call <code>make_fake_data()</code> that
will write those data to CSV files for a range of date-times.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_csv_files</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dttm</span>, <span class="va">num_stn</span>, <span class="va">file_path</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>    <span class="va">dttm</span>,</span>
<span>    \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">make_fake_data</span><span class="op">(</span><span class="va">num_stn</span><span class="op">)</span></span>
<span>      <span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">file_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"obs_"</span>, <span class="va">x</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">file_name</span>, sep <span class="op">=</span> <span class="st">","</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And run the function to create 24 hours of fake data, saving to
<code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">make_csv_files</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/harpCore/man/seq_dttm.html" class="external-link">seq_dttm</a></span><span class="op">(</span><span class="fl">2023112800</span>, <span class="fl">2023112823</span><span class="op">)</span>, <span class="fl">30</span>, <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we have a bunch of CSV files we need to function that will read
them in and return data in a format that <code><a href="../reference/read_obs_file.html">read_obs_file()</a></code>
and <code><a href="../reference/read_obs.html">read_obs()</a></code> can use. There are a couple of important
things to remember - the function should return a named list of data
frames and those data frames should be one for the data themselves and
one that contains information about the units and accumulation times of
the observations. We will call these data frames “synop” for the data
and “synop_params” for the information about units. “synop” is chosen so
that harp knows that these are near surface observations akin to
official SYNOP meteorological observations. We should also use a
parameter naming convention that harp knows (see
<code><a href="../reference/parameter_definitions.html">show_param_defs()</a></code>) as well as column names “SID” for
station ID and “elev” for station elevation. Note that we use namespaces
for all functions from packages to future proof the function in case we
want to use it in a package in the future.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">read_csv_obs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">file_name</span>, <span class="va">dttm</span>, <span class="va">parameter</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># read the csv data using read.csv</span></span>
<span>  <span class="va">obs_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">file_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># add a column for the date-time</span></span>
<span>  <span class="va">obs_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="va">obs_data</span>, valid_dttm <span class="op">=</span> <span class="va">dttm</span>, .before <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Change column names to names harp knows about using psub()</span></span>
<span>  <span class="co"># We wrap in suppressWarnings as we don't want it to warn about </span></span>
<span>  <span class="co"># substitutions that don't exist in case not all files contain all the </span></span>
<span>  <span class="co"># expected columnn names. </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">obs_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/harpCore/man/psub.html" class="external-link">psub</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">obs_data</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"stationId"</span>, <span class="st">"stationElevation"</span>, <span class="st">"TA"</span>, <span class="st">"FF10"</span>, <span class="st">"RR1"</span>, <span class="st">"RH2"</span>, <span class="st">"MSLP"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SID"</span>, <span class="st">"elev"</span>, <span class="st">"T2m"</span>, <span class="st">"S10m"</span>, <span class="st">"AccPcp1h"</span>, <span class="st">"RH2m"</span>, <span class="st">"Pmsl"</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Only return parameters that have been asked for</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parameter</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">parameter</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">parameter</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">parameter</span><span class="op">)</span></span>
<span>    <span class="va">obs_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>      <span class="va">obs_data</span>, </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">any_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"valid_dttm"</span>, <span class="st">"SID"</span>, <span class="st">"elev"</span>, <span class="va">parameter</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Make a data frame for parameter units</span></span>
<span>  <span class="va">obs_units</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">parameter</span>, <span class="op">~</span><span class="va">accum_hours</span>, <span class="op">~</span><span class="va">units</span>,</span>
<span>    <span class="st">"T2m"</span>     , <span class="fl">0</span>           , <span class="st">"degC"</span>,</span>
<span>    <span class="st">"S10m"</span>    , <span class="fl">0</span>           , <span class="st">"m/s"</span>,</span>
<span>    <span class="st">"AccPcp1h"</span>, <span class="fl">1</span>           , <span class="st">"kg/m^2"</span>,</span>
<span>    <span class="st">"RH2m"</span>    , <span class="fl">0</span>           , <span class="st">"fraction"</span>,</span>
<span>    <span class="st">"Pmsl"</span>    , <span class="fl">0</span>           , <span class="st">"hPa"</span>,</span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Filter the obs_units data frame to only those parameters that are in the </span></span>
<span>  <span class="co"># data</span></span>
<span>  <span class="va">obs_units</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">obs_units</span>, <span class="va">.data</span><span class="op">$</span><span class="va">parameter</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">obs_data</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># return the data as a named list</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>synop <span class="op">=</span> <span class="va">obs_data</span>, synop_params <span class="op">=</span> <span class="va">obs_units</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can now test the <code>read_csv_obs()</code> function on its own
or called by <code><a href="../reference/read_obs_file.html">read_obs_file()</a></code> by setting
<code>file_format = "csv_obs"</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">read_csv_obs</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"obs_2023112812.csv"</span><span class="op">)</span>, <span class="fl">2023112812</span><span class="op">)</span></span>
<span><span class="co">#&gt; $synop</span></span>
<span><span class="co">#&gt;    valid_dttm SID elev  T2m S10m AccPcp1h RH2m Pmsl</span></span>
<span><span class="co">#&gt; 1  2023112812   1   35 17.4 10.2      0.0 0.63  984</span></span>
<span><span class="co">#&gt; 2  2023112812   2  171  6.2  6.6      0.0 0.77 1017</span></span>
<span><span class="co">#&gt; 3  2023112812   3  127 32.0 23.8      0.0 0.89  974</span></span>
<span><span class="co">#&gt; 4  2023112812   4  147 10.2 17.1      3.4 0.95 1011</span></span>
<span><span class="co">#&gt; 5  2023112812   5  105 35.0  3.1      1.9 0.73 1012</span></span>
<span><span class="co">#&gt; 6  2023112812   6   52 23.5 21.5      1.0 0.70 1026</span></span>
<span><span class="co">#&gt; 7  2023112812   7  315 19.0 29.0      1.9 0.87 1012</span></span>
<span><span class="co">#&gt; 8  2023112812   8   78 11.4 16.3      1.2 0.76 1025</span></span>
<span><span class="co">#&gt; 9  2023112812   9  338 12.9 16.8      2.0 0.53 1011</span></span>
<span><span class="co">#&gt; 10 2023112812  10   49 10.9 16.1      0.0 0.50 1026</span></span>
<span><span class="co">#&gt; 11 2023112812  11   23  8.1  0.5      0.0 0.73 1008</span></span>
<span><span class="co">#&gt; 12 2023112812  12  139  7.8  7.7      2.5 0.94  978</span></span>
<span><span class="co">#&gt; 13 2023112812  13  190  5.1 15.3      1.5 0.68 1028</span></span>
<span><span class="co">#&gt; 14 2023112812  14  308  9.2 24.4      1.6 0.90  994</span></span>
<span><span class="co">#&gt; 15 2023112812  15   78  5.7 32.8      0.0 0.82  996</span></span>
<span><span class="co">#&gt; 16 2023112812  16  322 10.1 28.1      1.7 0.82  990</span></span>
<span><span class="co">#&gt; 17 2023112812  17   88 25.9 25.3      1.2 0.94 1006</span></span>
<span><span class="co">#&gt; 18 2023112812  18  291 29.6 20.9      5.4 0.58 1003</span></span>
<span><span class="co">#&gt; 19 2023112812  19  213  9.6 26.5      0.0 0.95 1025</span></span>
<span><span class="co">#&gt; 20 2023112812  20  151 19.5 30.1      7.3 0.78  985</span></span>
<span><span class="co">#&gt; 21 2023112812  21   54 26.7  1.6      0.0 0.65  994</span></span>
<span><span class="co">#&gt; 22 2023112812  22  205 19.6 33.9      1.1 0.79 1028</span></span>
<span><span class="co">#&gt; 23 2023112812  23   12  5.3 25.1      0.0 0.65 1011</span></span>
<span><span class="co">#&gt; 24 2023112812  24  115 24.9 24.3      1.1 0.95  997</span></span>
<span><span class="co">#&gt; 25 2023112812  25   88 14.6  6.3      0.0 0.85 1014</span></span>
<span><span class="co">#&gt; 26 2023112812  26  104 16.9 24.1      0.0 0.91  991</span></span>
<span><span class="co">#&gt; 27 2023112812  27  167 11.3 17.7      0.0 0.76  995</span></span>
<span><span class="co">#&gt; 28 2023112812  28   90 29.8  9.5      0.0 0.75  976</span></span>
<span><span class="co">#&gt; 29 2023112812  29  284 31.1  5.8      0.0 0.85  993</span></span>
<span><span class="co">#&gt; 30 2023112812  30  164 23.4  2.9      0.0 0.58  989</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $synop_params</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 3</span></span></span>
<span><span class="co">#&gt;   parameter accum_hours units   </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> T2m                 0 degC    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> S10m                0 m/s     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> AccPcp1h            1 kg/m^2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> RH2m                0 fraction</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Pmsl                0 hPa</span></span>
<span><span class="fu"><a href="../reference/read_obs_file.html">read_obs_file</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"obs_2023112812.csv"</span><span class="op">)</span>, <span class="cn">NULL</span>, </span>
<span>  dttm <span class="op">=</span> <span class="fl">2023112812</span>, file_format <span class="op">=</span> <span class="st">"csv_obs"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; $synop</span></span>
<span><span class="co">#&gt;    valid_dttm SID elev  T2m S10m AccPcp1h RH2m Pmsl</span></span>
<span><span class="co">#&gt; 1  1701172800   1   35 17.4 10.2      0.0 0.63  984</span></span>
<span><span class="co">#&gt; 2  1701172800   2  171  6.2  6.6      0.0 0.77 1017</span></span>
<span><span class="co">#&gt; 3  1701172800   3  127 32.0 23.8      0.0 0.89  974</span></span>
<span><span class="co">#&gt; 4  1701172800   4  147 10.2 17.1      3.4 0.95 1011</span></span>
<span><span class="co">#&gt; 5  1701172800   5  105 35.0  3.1      1.9 0.73 1012</span></span>
<span><span class="co">#&gt; 6  1701172800   6   52 23.5 21.5      1.0 0.70 1026</span></span>
<span><span class="co">#&gt; 7  1701172800   7  315 19.0 29.0      1.9 0.87 1012</span></span>
<span><span class="co">#&gt; 8  1701172800   8   78 11.4 16.3      1.2 0.76 1025</span></span>
<span><span class="co">#&gt; 9  1701172800   9  338 12.9 16.8      2.0 0.53 1011</span></span>
<span><span class="co">#&gt; 10 1701172800  10   49 10.9 16.1      0.0 0.50 1026</span></span>
<span><span class="co">#&gt; 11 1701172800  11   23  8.1  0.5      0.0 0.73 1008</span></span>
<span><span class="co">#&gt; 12 1701172800  12  139  7.8  7.7      2.5 0.94  978</span></span>
<span><span class="co">#&gt; 13 1701172800  13  190  5.1 15.3      1.5 0.68 1028</span></span>
<span><span class="co">#&gt; 14 1701172800  14  308  9.2 24.4      1.6 0.90  994</span></span>
<span><span class="co">#&gt; 15 1701172800  15   78  5.7 32.8      0.0 0.82  996</span></span>
<span><span class="co">#&gt; 16 1701172800  16  322 10.1 28.1      1.7 0.82  990</span></span>
<span><span class="co">#&gt; 17 1701172800  17   88 25.9 25.3      1.2 0.94 1006</span></span>
<span><span class="co">#&gt; 18 1701172800  18  291 29.6 20.9      5.4 0.58 1003</span></span>
<span><span class="co">#&gt; 19 1701172800  19  213  9.6 26.5      0.0 0.95 1025</span></span>
<span><span class="co">#&gt; 20 1701172800  20  151 19.5 30.1      7.3 0.78  985</span></span>
<span><span class="co">#&gt; 21 1701172800  21   54 26.7  1.6      0.0 0.65  994</span></span>
<span><span class="co">#&gt; 22 1701172800  22  205 19.6 33.9      1.1 0.79 1028</span></span>
<span><span class="co">#&gt; 23 1701172800  23   12  5.3 25.1      0.0 0.65 1011</span></span>
<span><span class="co">#&gt; 24 1701172800  24  115 24.9 24.3      1.1 0.95  997</span></span>
<span><span class="co">#&gt; 25 1701172800  25   88 14.6  6.3      0.0 0.85 1014</span></span>
<span><span class="co">#&gt; 26 1701172800  26  104 16.9 24.1      0.0 0.91  991</span></span>
<span><span class="co">#&gt; 27 1701172800  27  167 11.3 17.7      0.0 0.76  995</span></span>
<span><span class="co">#&gt; 28 1701172800  28   90 29.8  9.5      0.0 0.75  976</span></span>
<span><span class="co">#&gt; 29 1701172800  29  284 31.1  5.8      0.0 0.85  993</span></span>
<span><span class="co">#&gt; 30 1701172800  30  164 23.4  2.9      0.0 0.58  989</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $synop_params</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 3</span></span></span>
<span><span class="co">#&gt;   parameter accum_hours units   </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> T2m                 0 degC    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> S10m                0 m/s     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> AccPcp1h            1 kg/m^2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> RH2m                0 fraction</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Pmsl                0 hPa</span></span>
<span><span class="fu"><a href="../reference/read_obs_file.html">read_obs_file</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"obs_2023112812.csv"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"T2m"</span>, <span class="st">"S10m"</span><span class="op">)</span>, </span>
<span>  dttm <span class="op">=</span> <span class="fl">2023112812</span>, file_format <span class="op">=</span> <span class="st">"csv_obs"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; $synop</span></span>
<span><span class="co">#&gt;    valid_dttm SID elev  T2m S10m</span></span>
<span><span class="co">#&gt; 1  1701172800   1   35 17.4 10.2</span></span>
<span><span class="co">#&gt; 2  1701172800   2  171  6.2  6.6</span></span>
<span><span class="co">#&gt; 3  1701172800   3  127 32.0 23.8</span></span>
<span><span class="co">#&gt; 4  1701172800   4  147 10.2 17.1</span></span>
<span><span class="co">#&gt; 5  1701172800   5  105 35.0  3.1</span></span>
<span><span class="co">#&gt; 6  1701172800   6   52 23.5 21.5</span></span>
<span><span class="co">#&gt; 7  1701172800   7  315 19.0 29.0</span></span>
<span><span class="co">#&gt; 8  1701172800   8   78 11.4 16.3</span></span>
<span><span class="co">#&gt; 9  1701172800   9  338 12.9 16.8</span></span>
<span><span class="co">#&gt; 10 1701172800  10   49 10.9 16.1</span></span>
<span><span class="co">#&gt; 11 1701172800  11   23  8.1  0.5</span></span>
<span><span class="co">#&gt; 12 1701172800  12  139  7.8  7.7</span></span>
<span><span class="co">#&gt; 13 1701172800  13  190  5.1 15.3</span></span>
<span><span class="co">#&gt; 14 1701172800  14  308  9.2 24.4</span></span>
<span><span class="co">#&gt; 15 1701172800  15   78  5.7 32.8</span></span>
<span><span class="co">#&gt; 16 1701172800  16  322 10.1 28.1</span></span>
<span><span class="co">#&gt; 17 1701172800  17   88 25.9 25.3</span></span>
<span><span class="co">#&gt; 18 1701172800  18  291 29.6 20.9</span></span>
<span><span class="co">#&gt; 19 1701172800  19  213  9.6 26.5</span></span>
<span><span class="co">#&gt; 20 1701172800  20  151 19.5 30.1</span></span>
<span><span class="co">#&gt; 21 1701172800  21   54 26.7  1.6</span></span>
<span><span class="co">#&gt; 22 1701172800  22  205 19.6 33.9</span></span>
<span><span class="co">#&gt; 23 1701172800  23   12  5.3 25.1</span></span>
<span><span class="co">#&gt; 24 1701172800  24  115 24.9 24.3</span></span>
<span><span class="co">#&gt; 25 1701172800  25   88 14.6  6.3</span></span>
<span><span class="co">#&gt; 26 1701172800  26  104 16.9 24.1</span></span>
<span><span class="co">#&gt; 27 1701172800  27  167 11.3 17.7</span></span>
<span><span class="co">#&gt; 28 1701172800  28   90 29.8  9.5</span></span>
<span><span class="co">#&gt; 29 1701172800  29  284 31.1  5.8</span></span>
<span><span class="co">#&gt; 30 1701172800  30  164 23.4  2.9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $synop_params</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">#&gt;   parameter accum_hours units</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> T2m                 0 degC </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> S10m                0 m/s</span></span></code></pre></div>
<p>Note the difference in the valid_dttm column.
<code>read_csv_obs()</code> returns the date times that were given to
it, whereas <code><a href="../reference/read_obs_file.html">read_obs_file()</a></code> converts the
<strong>valid_dttm</strong> column to UNIX epoch time format - that is
number of seconds since 00:00:00 1 Januray 1970. This is because this is
the most efficient way to store and process date-time data.</p>
<p>If we want to use the observations throughout harp, for example for
point observations, it is most efficient to convert the observations to
SQLite format, which is much quicker to access and filter to what we
need using <code><a href="../reference/read_point_obs.html">read_point_obs()</a></code>. This process is done using
<code><a href="../reference/read_obs.html">read_obs()</a></code> and setting output_format_opts.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/read_obs.html">read_obs</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/harpCore/man/seq_dttm.html" class="external-link">seq_dttm</a></span><span class="op">(</span><span class="fl">2023112800</span>, <span class="fl">2023112823</span><span class="op">)</span>, </span>
<span>  <span class="cn">NULL</span>, </span>
<span>  file_format        <span class="op">=</span> <span class="st">"csv_obs"</span>, </span>
<span>  file_path          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  file_template      <span class="op">=</span> <span class="st">"obs_{YYYY}{MM}{DD}{HH}.csv"</span>,</span>
<span>  output_format_opts <span class="op">=</span> <span class="fu"><a href="../reference/sqlite_opts.html">obstable_opts</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"OBSTABLE"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ***</span></span>
<span><span class="co">#&gt; New SQLITE obs file created: /tmp/RtmpsHBatv/OBSTABLE/OBSTABLE_2023.sqlite</span></span>
<span><span class="co">#&gt; ***</span></span>
<span><span class="co">#&gt; Writing to: SYNOP in /tmp/RtmpsHBatv/OBSTABLE/OBSTABLE_2023.sqlite</span></span>
<span><span class="co">#&gt; No data returned. Set `return_data = TRUE` to return data.</span></span></code></pre></div>
<p>And then read the data back in using
<code><a href="../reference/read_point_obs.html">read_point_obs()</a></code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/read_point_obs.html">read_point_obs</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/harpCore/man/seq_dttm.html" class="external-link">seq_dttm</a></span><span class="op">(</span><span class="fl">2023112803</span>, <span class="fl">2023112819</span><span class="op">)</span>, <span class="st">"T2m"</span>, </span>
<span>  obs_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"OBSTABLE"</span><span class="op">)</span>, stations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">9</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Getting T2m.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Reading: /tmp/RtmpsHBatv/OBSTABLE/OBSTABLE_2023.sqlite</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 51 × 5</span></span></span>
<span><span class="co">#&gt;    valid_dttm            SID  elev   T2m units</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2023-11-28 <span style="color: #949494;">03:00:00</span>     4   147  10.2 degC </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2023-11-28 <span style="color: #949494;">03:00:00</span>     6    52  23.5 degC </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2023-11-28 <span style="color: #949494;">03:00:00</span>     9   338  12.9 degC </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2023-11-28 <span style="color: #949494;">04:00:00</span>     4   147  10.2 degC </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2023-11-28 <span style="color: #949494;">04:00:00</span>     6    52  23.5 degC </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2023-11-28 <span style="color: #949494;">04:00:00</span>     9   338  12.9 degC </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2023-11-28 <span style="color: #949494;">05:00:00</span>     4   147  10.2 degC </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2023-11-28 <span style="color: #949494;">05:00:00</span>     6    52  23.5 degC </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2023-11-28 <span style="color: #949494;">05:00:00</span>     9   338  12.9 degC </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2023-11-28 <span style="color: #949494;">06:00:00</span>     4   147  10.2 degC </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 41 more rows</span></span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Andrew Singleton, Alex Deckmyn.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
